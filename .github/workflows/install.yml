name: Install
on:
  release:
    types: [published]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to install (e.g., open-composer@1.0.0)'
        default: 'open-composer@latest'
        required: false
        type: string
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.head_ref || github.sha }}
  cancel-in-progress: true
jobs:
  install-e2e-cli:
    if: (github.event.release.tag_name && startsWith(github.event.release.tag_name, 'open-composer@')) || (github.event.inputs.tag && startsWith(github.event.inputs.tag, 'open-composer@')) || github.event_name == 'schedule'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      matrix:
        os: 
          - ubuntu-latest
          - macos-latest
          - windows-latest
      fail-fast: false
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.tag_name || github.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@v5
      - name: Install open-composer globally with retry
        uses: nick-fields/retry@v3
        with:
          retry_wait_seconds: 30
          timeout_seconds: 300
          max_attempts: 10
          command: npm install -g ${{ github.event.release.tag_name || github.event.inputs.tag || 'open-composer@latest' }}
      - name: Verify opencomposer command
        run: open-composer --version
  install-e2e-script:
    if: (github.event.release.tag_name && startsWith(github.event.release.tag_name, 'open-composer@')) || (github.event.inputs.tag && startsWith(github.event.inputs.tag, 'open-composer@')) || github.event_name == 'schedule'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
      fail-fast: false
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.tag_name || github.ref }}
      - name: Test install.sh script with retry
        uses: nick-fields/retry@v3
        with:
          retry_wait_seconds: 30
          timeout_seconds: 300
          max_attempts: 10
          command: bash install.sh
      - name: Verify open-composer command after script install
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          open-composer --version
        shell: bash
  install-e2e-brew:
    if: (github.event.release.tag_name && startsWith(github.event.release.tag_name, 'open-composer@')) || (github.event.inputs.tag && startsWith(github.event.inputs.tag, 'open-composer@')) || github.event_name == 'schedule'
    runs-on: macos-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.tag_name || github.ref }}
      - name: Setup Homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - name: Install open-composer via brew with retry
        uses: nick-fields/retry@v3
        with:
          retry_wait_seconds: 30
          timeout_seconds: 300
          max_attempts: 10
          command: brew install shunkakinoki/tap/open-composer
      - name: Verify open-composer command after brew install
        run: open-composer --version
  install-check:
    if: always()
    needs:
      - install-e2e-cli
      - install-e2e-script
      - install-e2e-brew
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Alls Green
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
          allowed-skips: install-e2e-cli,install-e2e-script,install-e2e-brew
