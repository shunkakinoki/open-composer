#!/usr/bin/env sh
set -e

# -----------------------------------------------------------------------------
# Determine binary path
# -----------------------------------------------------------------------------

# Get the script's directory
script_dir="$(cd "$(dirname "$0")" && pwd)"

# Use OPENCOMPOSER_BIN_PATH if set, otherwise determine binary path
if [ -n "$OPENCOMPOSER_BIN_PATH" ]; then
  resolved="$OPENCOMPOSER_BIN_PATH"
else
  # ---------------------------------------------------------------------------
  # Map platform names
  # ---------------------------------------------------------------------------

  case "$(uname -s)" in
    Darwin) platform="darwin" ;;
    Linux) platform="linux" ;;
    MINGW*|CYGWIN*|MSYS*) platform="win32" ;;
    *) platform="$(uname -s | tr '[:upper:]' '[:lower:]')" ;;
  esac

  # ---------------------------------------------------------------------------
  # Map architecture names
  # ---------------------------------------------------------------------------

  case "$(uname -m)" in
    x86_64|amd64) arch="x64" ;;
    aarch64|arm64) arch="arm64" ;;
    armv7l) arch="arm" ;;
    *) arch="$(uname -m)" ;;
  esac

  binary="open-composer"
  [ "$platform" = "win32" ] && binary="open-composer.exe"

  # ---------------------------------------------------------------------------
  # Look for binary in multiple locations
  # ---------------------------------------------------------------------------

  # First check if binary exists in the same directory (postinstall places it here)
  if [ -f "$script_dir/$binary" ]; then
    resolved="$script_dir/$binary"
  # Then check in node_modules (development mode)
  elif [ -f "$script_dir/../node_modules/@open-composer/cli-${platform}-${arch}/bin/${binary}" ]; then
    resolved="$script_dir/../node_modules/@open-composer/cli-${platform}-${arch}/bin/${binary}"
  else
    echo "Error: Binary not found for @open-composer/cli-${platform}-${arch}. Please ensure the correct version is installed." >&2
    exit 1
  fi
fi

# -----------------------------------------------------------------------------
# Execute the binary with all arguments
# -----------------------------------------------------------------------------

exec "$resolved" "$@"
